#!/bin/bash

source /opt/ioi/config.sh

ZENARG='--width=300'
ZENTITLE='--title=IOI Setup'

USERID=
CRED=

main()
{
    while true; do
        do_setup
        if [ $? -eq 1 ]; then
            break
        fi
    done
}

do_setup()
{
    CRED=$(zenity "$ZENTITLE" $ZENARG \
        --forms --text "Enter contestant credentials" \
        --add-entry=Username: \
        --add-password=Password:
    )

    if [ $? -eq 1 ]; then
        return 1
    fi

    do_core_setup 

    local retval=${PIPESTATUS[0]}
    return ${retval}
}

do_core_setup()
{
    # Populate root's known_hosts
    sudo /opt/ioi/bin/ioiconf.sh keyscan

    # Trigger downloading new ansible pubkey
    sudo /opt/ioi/bin/ioiconf.sh getpubkey
    if [ $? -ne 0 ]; then
        echo "100"
        return 2  # connection issue
    fi

    echo "100"
    return 1
}

logger -p local0.info "IOISETUP: invoked"
main "$@"; exit

# vim: ft=sh ts=4 sw=4 noet
